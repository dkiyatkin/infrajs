(function(){var t,e=[].slice,n={}.hasOwnProperty;t=function(){function t(o){var i,s,c,a,l,u,h,d,p,f,g,m,y,v,x,w,b,_,j,k,S,T,O,q,A,M,$,C,E,L,H,R,P,N,X,I,B,D,G,K,U,V=this;this.options=null!=o?o:{},this.layers=[],this.log={debug:function(){var t;return t=arguments.length>=1?e.call(arguments,0):[],j(t,3)},info:function(){var t;return t=arguments.length>=1?e.call(arguments,0):[],j(t,2)},warn:function(){var t;return t=arguments.length>=1?e.call(arguments,0):[],j(t,1)},error:function(){var t;return t=arguments.length>=1?e.call(arguments,0):[],j(t,0)},logger:"WARNING",quiet:!1},this.options.log&&(this.log.logger=this.options.log),this.options.logger&&(this.log.logger=this.options.logger),k=["ERROR","WARNING","INFO","DEBUG"],j=function(t,e){return k.indexOf(V.log.logger)>=e?(t="["+(new Date).toGMTString()+"] "+k[e]+" "+t.join(" "),V.log.quiet||(3===e&&console.log(t),2===e&&console.info(t),1===e&&console.warn(t),0===e&&console.error(t)),t):void 0},this.options.document?this.document=this.options.document:"undefined"!=typeof window&&null!==window&&(this.document=window.document),this.$=this.options.$?this.options.$:function(t){var e;return e=V.document.querySelectorAll(t),1===e.length&&(e=e[0]),e.find=function(t){var n,r,o,i;if(i=[],e&&e.length)for(n=e.length;--n>=0;)for(o=e[n].querySelectorAll(t),r=o.length;--r>=0;)i.push(o[r]);else i=e.querySelectorAll(t);return 1===i.length&&(i=i[0]),i},e},K={},D={},this.on=function(t,e){return K[t]||(K[t]=[]),K[t].push(e)},this.once=function(t,e){return K[t]||(K[t]=[]),D[t]||(D[t]=[]),K[t].push(e),D[t].push(e)},this.emit=function(t){var e,n,r,o,i,s;if(K[t]){for(e=Array.prototype.slice.call(arguments).slice(1),r=0,o=K[t].length,s=[];o>r;)n=K[t][r],n&&(D[t]&&(i=D[t].indexOf(n),i>-1&&(D[t].splice(i,1),K[t].splice(r,1),r--)),n.apply(this,e)),s.push(r++);return s}},this.listeners=function(t){return K[t]||(K[t]=[]),K[t]},this.removeAllListeners=function(t){return K[t]=[],D[t]=[]},-1===Object.keys(this.options).indexOf("loader")&&(this.options.loader=!0),this.options.loader&&(_=!1,w=!1,this.loader={src:"../images/loader.gif",show:function(){V.emit("create_loader"),w.setAttribute("style","cursor:progress");try{_.setAttribute("src",V.loader.src),w.appendChild(_)}catch(t){V.log.error("error show loader")}return!0},hide:function(){try{w.removeChild(_)}catch(t){V.log.error("error hide loader")}return w.setAttribute("style","cursor:auto"),!0}},this.on("start",function(){return V.loader.show()}),this.on("end",function(){return V.loader.hide()}),this.once("create_loader",function(){return w=V.$("html"),_=V.document.createElement("img"),_.setAttribute("style","z-index:1000;display:block;width:30px;height:30px;left:50%;top:50%;position:fixed;margin-left:-15px;margin-top:-15px;")})),U={},this.load=function(t,e,n){return n||(n=e),e||(e={}),e.type||(e.type="text"),V.load.cache.text[t]?n(null,V.load.cache.text[t]):U[t]?(V.log.debug("add load queue for "+t),V.once("load: "+t,function(e){return n(e,V.load.cache.text[t])})):(U[t]=!0,V.load.load(t,e,function(e,r){return V.load.cache.text[t]=r,e&&V.log.error("error load "+t),U[t]=!1,V.emit("load: "+t,e),n(e,V.load.cache.text[t])}))},this.load.load=function(t,e,n){var r;return n||(n=e),e||(e={}),e.type||(e.type="text"),r=u(),r.open("GET",t,!0),"json"===e.type?(r.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),r.setRequestHeader("Accept","application/json, text/javascript")):r.setRequestHeader("Content-Type","text/plain; charset=UTF-8"),r.onreadystatechange=function(){return 4===r.readyState?200===r.status?n(0,r.responseText):n(0,null):void 0},r.send(null)},this.options.load&&(this.load.load=this.options.load),this.load.json=function(t,e,n){return n||(n=e),e||(e={}),e.type="json",V.load.cache.data[t]?n(null,V.load.cache.data[t]):V.load(t,e,function(e,r){try{V.load.cache.data[t]=JSON.parse(r)}catch(o){V.log.error("wrong json data "+t)}return n(e,V.load.cache.data[t])})},this.load.js=function(t,e,n){return n||(n=e),e||(e={}),e.type="text",/^http(s){0,1}:\/\//.test(t)?(H(t),n(0)):V.load(t,function(e,r,o){if(e)return n(e);try{return y(o),n(0)}catch(i){return this.log.error("wrong js "+t),n(i)}})},this.load.exec=this.load.js,N=!1,this.load.script=function(t){if(N)return setTimeout(function(){return this.load.script(t)},1),void 0;if(N=!0,t.src)return V.load.js(t.src,function(){return N=!1});try{y(t.innerHTML)}catch(e){V.log.error("Ошибка в скрипте.")}return N=!1},this.load.css=function(t){var e,n;if(!V.load.cache.css[t])return V.load.cache.css[t]=!0,n=V.document.createElement("style"),n.type="text/css",n.styleSheet?n.styleSheet.cssText=t:n.appendChild(V.document.createTextNode(t)),e=V.$("head"),e.insertBefore(n,e.lastChild)},this.load.style=this.load.styles=this.load.css,this.load.clearCache=function(t){return null==t?(V.load.cache.data={},V.load.cache.text={}):t.constructor===RegExp?(I(t,V.load.cache.data),I(t,V.load.cache.text)):(delete V.load.cache.data[t],delete V.load.cache.text[t])},this.load.cache={css:{},data:{},text:{}},I=function(t,e){var r,o;o=[];for(r in e)n.call(e,r)&&(t.test(r)?o.push(delete e[r]):o.push(void 0));return o},u=function(){var t;return"undefined"!=typeof XMLHttpRequest&&null!==XMLHttpRequest?new XMLHttpRequest:(t=function(){try{return new ActiveXObject("Msxml2.XMLHTTP.6.0")}catch(t){}try{return new ActiveXObject("Msxml2.XMLHTTP.3.0")}catch(t){}try{return new ActiveXObject("Msxml2.XMLHTTP")}catch(t){}try{return new ActiveXObject("Microsoft.XMLHTTP")}catch(t){}throw Error("This browser does not support XMLHttpRequest.")},t())},y=function(t){var e,n;return e=V.$("head"),n=V.document.createElement("script"),n.type="text/javascript",n.text=t,e.insertBefore(n,e.firstChild),e.removeChild(n)},H=function(t){var e,n;return n=V.document.createElement("script"),n.type="text/javascript",e=V.$("head"),n.src=t,e.insertBefore(n,e.firstChild),e.removeChild(n)},d=function(t){return t()},this.options.index&&(this.index=this.options.index),a=1,this.options.check_queue&&(a=this.options.check_queue),c=100,this.options.check_limit&&(c=this.options.check_limit),l=1e4,this.options.check_timeout&&(l=this.options.check_timeout),this.check_status="stop",this.check_count=0,B=function(t){var e,r,o,i;e={},i=[];for(r in t)n.call(t,r)&&(o=t[r],i.push(V.emit("compile",e,r,o)));return i},this.compile=function(t){var e,n,r;if(t&&(V.index=t),V.layers=[],V.index.splice)for(e=V.index.length;--e>=0;)B(V.index[e]);else B(V.index);for(V.ids={},e=V.layers.length,r=[];--e>=0;)n=V.layers[e],n.oncheck||(n.oncheck=d),n.onload||(n.onload=d),n.onshow||(n.onshow=d),n.config||(n.config={}),n.state||(n.state="/"),n.id||(n.id=e),V.ids[n.id]=n,"^"!==n.state[0]&&"$"!==n.state.slice(-1)?r.push(n.state="^"+n.state+".*$"):r.push(void 0);return r},this.on("start",function(){return V.log.debug("first circle, queue: "+V.listeners("queue").length),V.circle={interrupt:!1,count:0,occupied:{},loading:0,state:V.state,limit:c,queue:a,length:V.layers.length,cb:null,timeout:l,time:Date.now()}}),this.on("circle",function(){var t;return t=V.check_count,setTimeout(function(){var e,n;if("run"===V.check_status&&t===V.check_count){for(e=V.circle.length;--e>=0;)"queue"===V.layers[e].status&&(V.circle.num=e,V.emit("layer",V.layers[e],e));if(n=V.listeners("circle"),++V.circle.count>=V.circle.limit&&(V.log.warn(V.circle.limit+" limit"),n=n.splice(1,n.length)),V.circle.timeout<Date.now()-V.circle.time&&(V.log.warn(V.circle.timeout+" timeout"),n=n.splice(1,n.length)),n.length>1)return V.emit("circle");if(!V.circle.loading)return V.emit("end")}},1)}),f=function(t){var e;if(V.check_status="run",V.circle.cb=t,V.circle.state){for(e=V.circle.length;--e>=0;)V.layers[e].status="queue",V.layers[e].node=null;return V.emit("circle")}return V.log.warn("no set circle.state"),V.emit("end")},this.on("end",function(){return V.log.debug("end check, circle.count: "+V.circle.count+", check_count: "+V.check_count),"function"==typeof V.circle.cb?V.circle.cb(function(){return V.check_status="stop1"}):V.check_status="stop2",V.emit("queue")}),this.check=function(t){var e;return"run"===V.check_status?(V.circle.interrupt=!0,V.once("queue",function(){return V.check(t)}),e=V.listeners("queue"),e.splice(0,e.length-V.circle.queue),V.log.debug("check queue, listeners "+e.length)):"pause"!==V.check_status?(V.check_count++,V.layers.length||V.compile(),V.layers.length||V.log.info("empty layers"),V.emit("start"),t!==!0?f(t):V.check_status="pause"):t!==!0?f(t):void 0},T=["tag","state","css","json","tpl","ext","tplString","htmlString","id"],q=["config","data"],O=["oncheck","onload","onshow"],this.labels={},this.on("compile",function(t,e,n){var r,o,i;if(T.indexOf(e)>=0)return"[object String]"===Object.prototype.toString.apply(n)?("tag"===e&&-1===V.layers.indexOf(t)&&V.layers.push(t),t[e]=n):V.log.error("bad value",e,n);if(q.indexOf(e)>=0)return"[object Object]"===Object.prototype.toString.apply(n)?t[e]=n:V.log.error("bad value",e,n);if(O.indexOf(e)>=0)return t["_"+e]=n,V.functions&&"[object String]"===Object.prototype.toString.apply(n)&&V.functions[n]&&(n=V.functions[n]),t[e]=function(r){try{return n.call(t,r)}catch(o){return V.log.error(e+" "+o),r()}};if("div"===e)return"[object String]"===Object.prototype.toString.apply(n)?t.tag="#"+n:V.log.error("bad value",e,n);if("label"===e){if("[object String]"===Object.prototype.toString.apply(n)){for(t[e]=n,o=n.replace(/\s+/g," ").trim().split(" "),r=o.length,i=[];--r>=0;)V.labels[o[r]]||(V.labels[o[r]]=[]),i.push(V.labels[o[r]].push(t));return i}return V.log.error("bad value",e,n)}}),M=["states","tags","divs"],this.on("compile",function(t,e,r){var o,i,s,c,a,l;if(M.indexOf(e)>=0){if("[object Object]"===Object.prototype.toString.apply(r)){-1===V.layers.indexOf(t)&&V.layers.push(t),t.childs||(t.childs=[]),"states"!==e||t.states||(t.states={}),"tags"!==e&&"divs"!==e||t.tags||(t.tags={}),l=[];for(i in r)n.call(r,i)&&("[object Object]"===Object.prototype.toString.apply(r[i])?(o={},o.parent=t,V.layers.push(o),t.childs.push(o),"states"===e?(c=i,t.states[c]=o,"^"===c[0]||"$"===c.slice(-1)?o.state=c:(o.parent.state||(o.parent.state="/"),o.state=o.parent.state+c+"/")):(a="tags"===e?i:"#"+i,o.tag=a,o.state=t.state,t.tags[o.tag]=o),l.push(function(){var t,e;t=r[i],e=[];for(s in t)n.call(t,s)&&e.push(this.emit("compile",o,s,r[i][s]));return e}.call(V))):l.push(V.log.error("bad value",e,r[i])));return l}return V.log.error("bad value",e,r)}}),this.external=function(t,e){return t.ext&&!t._ext?(V.log.debug("new external",t.ext),V.load(t.ext,function(r,o){var i,s,c,a,l,u,h,d,p;if(t._ext={},r)return e();try{try{t._ext=eval_("("+o+")")}catch(f){t._ext=eval_(o)}if(c=this.layers,this.compile(t._ext),t._ext=this.layers,this.layers=c,t.config&&t._ext[0].config){d=t._ext[0].config;for(u in d)n.call(d,u)&&(t.config[u]||(t.config[u]=t._ext[0].config[u]))}p=t._ext[0];for(h in p)n.call(p,h)&&(t[h]||(t[h]=t._ext[0][h]));for(i=["onload","oncheck","onshow"],s=0,a=i.length;a>s;)(function(e){var n;return n=t["_"+e],n?t[e]=function(r){try{return n.call(t,r)}catch(o){return this.log.error(e+" "+o),r()}}:void 0})(i[s]),s++;if(a=t._ext.length)for(l=this.layers.indexOf(t),s=1;a>s;)l++,this.layers.splice(l,0,t._ext[s]),s++;return e()}catch(f){return this.log.error("wrong ext",t.ext),e()}})):e()},this.tplParser=function(t,e,n){var r;return r="tplParser is not set",n?n(r):r},this.options.tplParser&&(this.tplParser=this.options.tplParser),E=function(t,e){return t.onload(function(){return"string"==typeof t.tplString?V.tplParser(t.tplString,t,function(n){return t.htmlString=n,e()}):(V.log.error("Wrong tplString "+t.tpl),t.htmlString=" ",e())})},L=function(t,e){return t.tplString?e():(t.tplString=" ",t.tpl?V.load(t.tpl,function(n,r){return n||(t.tplString=r),e()}):e())},$=function(t,e){return t.data?e():(t.data={},t.json?V.load.json(t.json,function(n,r){return n||(t.data=r),e()}):e())},this.insert=function(t,e){var n,r;return n=2,r=function(){return 0===--n?E(t,function(){return e()}):void 0},t.htmlString?e():t.tpl||t.tplString?(L(t,function(){return r()}),$(t,function(){return r()})):e(1)},P=function(t){return t.parent&&!t.parent.show?"no parent":V.circle.occupied[t.tag]?"busy tag "+t.tag:(t.node||(t.node=V.$(t.tag)),t.node&&0!==t.node.length?!t.show&&s(t)?4:R(t)?!0:"state mismatch":"not inserted")},this.checkLayer=P,s=function(t){var e,r,o;t.node||(t.node=V.$(t.tag)),o=V.circle.occupied;for(r in o)if(n.call(o,r)&&t.node&&t.node.length&&(e=t.node.find(V.circle.occupied[r]),e&&0!==e.length))return!0;return!1},R=function(t){return t.reg_state&&t.reg_state[0]&&V.circle.state===t.reg_state[0]?!0:!1},this.pasteHTML=function(t,e){var n,o,i,s,c,a,l,u,h,d;if(s=V.$(t),!/<(style+)([^>]+)*(?:>)/g.test(e)&&!/<(script+)([^>]+)*(?:>)/g.test(e))return s.innerHTML=e;V.document.scriptautoexec=!1,h="infrahtml"+r(),e='<span id="'+h+'" style="display:none">'+"<style>#"+h+"{ width:3px }</style>"+'<script type="text/javascript">document.scriptautoexec=true;</script>'+"1</span>"+e;try{s.innerHTML=e}catch(p){s.innerHTML="Ошибка вставки"}if(!V.document.scriptautoexec)for(l=s.getElementsByTagName("script"),c=1,a=void 0;a=l[c];)V.load.script(a),c++;if(o=V.document.getElementById(h)){if(n=m(o,"width"),"3px"!==n)for(d=s.getElementsByTagName("style"),c=0,i=void 0;i=d[c];)u=i.cssText,V.load.styles(u),c++;try{return s.removeChild(o)}catch(p){return V.log.error("Ошибка при удалении временного элемента")}}},G=function(t){var e;if(t.status="_hide",t.childs)for(e=t.childs.length;--e>=0;)G(t.childs[e]);return V.pasteHTML(t.tag,""),t.show=!1,t.status="hidden"},x=function(t){return t.status="hide",G(t)},h=function(t){var e,n,r;for(t.status="displace",n=V.circle.length,r=[];--n>=0;)V.layers[n].show?t.tag===V.layers[n].tag||(V.$(t.tag)===V.$(V.layers[n].tag)?r.push(G(V.layers[n])):(e=V.$(t.tag).find(V.layers[n].tag),e&&0!==e.length?r.push(G(V.layers[n])):r.push(void 0))):r.push(void 0);return r},i=function(t){return t.status="apply",V.circle.occupied[t.tag]=t,t.show||h(t),V.once("circle",function(){return V.circle.interrupt?(V.log.debug("check interrupt 1"),V.emit("circle")):(V.circle.loading++,V.external(t,function(){return t.oncheck(function(){return t.now_state=V.circle.state,t.status="insert",t.show?(V.circle.loading--,V.emit("circle")):V.insert(t,function(e){return e?(V.log.error("layer can not be inserted",t.id),t.status="wrong insert",V.circle.loading--,V.emit("circle")):V.circle.interrupt?(V.log.debug("check interrupt 2"),V.circle.loading--,V.emit("circle")):(V.pasteHTML(t.tag,t.htmlString),t.last_state=V.circle.state,t.show=!0,t.onshow(function(){return V.circle.loading--,V.emit("circle")}))})})}))})},this.on("layer",function(t){return t.check=P(t),t.check===!0?i(t):t.show?x(t):void 0}),null==this.options.links&&(this.options.links=!1),b=["^javascript:","^mailto:","^http://","^https://","^ftp://","^//"],this.getState=function(t){var e;return t||(t="/"),e=decodeURIComponent(location.pathname),t=decodeURIComponent(t),t=t.replace(/#.+/,""),"/"!==t[0]&&(t=e+"/"+t),t=t.replace(/\/{2,}/g,"/")},A=function(t){return"A"===t.nodeName?t:t.parentNode&&"HTML"!==t.parentNode?A(t.parentNode):!1},v=function(t){var e,n,r,o;if(t=t||window.event,!(t.metaKey||t.shiftKey||t.altKey||t.ctrlKey)&&(o=t.target||t.srcElement,o=A(o),o&&(e=o.getAttribute("href"),r=!1,e&&!o.getAttribute("target")))){for(n=b.length;--n>=0;)RegExp(b[n],"gim").test(e)&&(r=!0);if(!r)try{return t.preventDefault?t.preventDefault():t.returnValue=!1,V.state=V.getState(e),V.check(function(t){return V.hash=o.hash,t()})}catch(t){return window.location=e}}},C=function(){var t,e,n;for(t=V.$("a"),e=t.length,n=[];--e>=0;)n.push(t[e].onclick=v);return n},this.options.links&&(C(),this.on("start",function(){return V.noscroll||window.scrollTo(0,0),V.noscroll=!1}),this.on("end",function(){return C()})),null==this.options.address_bar&&(this.options.address_bar=!1),this.options.address_bar&&(this.state=this.getState(location.pathname),this.log.debug("setting onpopstate event for back and forward buttons"),setTimeout(function(){return window.onpopstate=function(){var t;return V.log.debug("onpopstate"),V.hash?void 0:(t=V.getState(location.pathname),V.state=t,V.check(function(t){return V.hash=location.hash,t()}))}},1e3),S=void 0,this.on("start",function(){return S=V.getState(location.pathname),V.state!==S?(V.log.debug("push state "+V.state+" replace hash "+V.hash),history.pushState(null,null,V.state)):void 0}),this.on("end",function(){return V.state!==S?V.hash&&location.replace(V.hash):(V.log.debug("replace state "+V.state+" push hash "+V.hash),history.replaceState(null,null,V.state),V.hash&&(location.href=V.hash)),V.hash=""})),null==this.options.cache&&(this.options.cache=!1),p=function(){},g=function(){var e,n,r;for(t=window.Infra,V.load.cache=t.server.cache,e=V.layers.length,r=[];--e>=0;)if(n=V.layers[e],n.show=t.server.showns[e],n.show){!n.data&&n.json&&V.load.cache.data[n.json]&&(n.data=V.load.cache.data[n.json]),!n.htmlString&&!n.tplString&&n.tpl&&V.load.cache.text[n.tpl]&&(n.tplString=V.load.cache.text[n.tpl]),n.reg_state=V.state.match(RegExp(n.state,"im"));try{r.push(n.onshow.bind(n)(p))}catch(o){r.push(V.log.error("onshow() "+e+" "+o))}}else r.push(void 0);return r},this.options.cache&&this.once("start",function(){try{return g()}catch(t){return V.log.warn("fail cache")}}),this.reparseLayer=function(t){var e,n;if(t.show=!1,t.json&&(t.data=!1),t.tpl?(t.tplString="",t.htmlString=""):t.tplString&&(t.htmlString=""),t.childs){for(e=t.childs.length,n=[];--e>=0;)n.push(t.childs[e].show=!1);return n}},this.reparseAll=function(){var t,e;for(t=V.layers.length,e=[];--t>=0;)e.push(V.reparseLayer(V.layers[t]));return e},X=function(t,e){var n,r;for(n=void 0,r=V.layers.length;--r>=0&&!(n=RegExp(V.layers[r].state).test(t)););return e(n)},this.checkExists=function(t,e){return V.layers.length?X(t,e):(V.compile(V.index),X(t,e))},this.oncheckTplOptions=function(t,e){var n,r;return e||(e=V),n=2,r=function(){return 0===--n?t():void 0},V.tplParser(e.tpl,e,function(t){return e.tpl=t,r()}),V.tplParser(e.json,e,function(t){return e.json=t,r()})},this.head=function(t){return V.on("start",function(){return V.meta={},V.meta.keywords=t.meta.keywords,V.meta.description=t.meta.description,V.status_code=200,V.title=!1}),V.on("end",function(){var e,n,r,o;return V.title||(V.title=404===V.status_code?t.title["404"]:"/"===V.state?t.title.main:V.state.replace(/\/+$/,"").replace(/^\/+/,"").split("/").reverse().join(" / ")+t.title.sub,V.last_status_code=V.status_code),V.document.title=V.title,V.meta.keywords||(V.meta.keywords=""),V.meta.description||(V.meta.description=""),n=V.$("head"),e=V.$("meta[name=description]"),r=V.$("meta[name=keywords]"),r&&0!==r.length&&n.removeChild(r),e&&0!==e.length&&n.removeChild(e),o=V.document.createElement("meta"),o.setAttribute("name","description"),o.setAttribute("content",V.meta.description),n.appendChild(o),o=V.document.createElement("meta"),o.setAttribute("name","keywords"),o.setAttribute("content",V.meta.keywords),n.appendChild(o)})},this.on("compile",function(t,e,n){return"jsontpl"===e?t[e]=n:void 0}),this.on("start",function(){var t,e;for(t=V.layers.length,e=[];--t>=0;)V.state&&(V.layers[t].reg_state=V.state.match(RegExp(V.layers[t].state,"im"))),V.layers[t].jsontpl?e.push(V.layers[t].json=V.tplParser(V.layers[t].jsontpl,V.layers[t])):e.push(void 0);return e}),m=function(t,e){return t.currentStyle?t.currentStyle[e]:V.document.defaultView&&V.document.defaultView.getComputedStyle?V.document.defaultView.getComputedStyle(t,"")[e]:t.style[e]}}var r;return r=function(t){var e;for(null==t&&(t=8),e="";t>e.length;)e+=Math.random().toString(36).substr(2);return e.substr(0,t)},t}(),"undefined"==typeof window||null===window?module.exports=t:window.Infra=t}).call(this);