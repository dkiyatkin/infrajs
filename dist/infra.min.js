(function(){var t,e=[].slice,n={}.hasOwnProperty;t=function(){function t(r){var o,i,s,a,c,l,u,h,d,p,f,g,m,y,v,x,w,b,_,k,j,S,O,T,q,A,$,M,R,L,C,E,H,P,X,N,I,D,G,B,K=this;this.options=null!=r?r:{},this.layers=[],this.log={debug:function(){var t;return t=arguments.length>=1?e.call(arguments,0):[],b(t,3)},info:function(){var t;return t=arguments.length>=1?e.call(arguments,0):[],b(t,2)},warn:function(){var t;return t=arguments.length>=1?e.call(arguments,0):[],b(t,1)},error:function(){var t;return t=arguments.length>=1?e.call(arguments,0):[],b(t,0)},logger:"WARNING",quiet:!1},this.options.log&&(this.log.logger=this.options.log),this.options.logger&&(this.log.logger=this.options.logger),_=["ERROR","WARNING","INFO","DEBUG"],b=function(t,e){return _.indexOf(K.log.logger)>=e?(t="["+(new Date).toGMTString()+"] "+_[e]+" "+t.join(" "),K.log.quiet||(3===e&&console.log(t),2===e&&console.info(t),1===e&&console.warn(t),0===e&&console.error(t)),t):void 0},this.options.document?this.document=this.options.document:"undefined"!=typeof window&&null!==window&&(this.document=window.document),this.$=this.options.$?this.options.$:function(t){var e;return e=K.document.querySelectorAll(t),1===e.length&&(e=e[0]),e.find=function(t){var n,r,o,i;if(i=[],e&&e.length)for(n=e.length;--n>=0;)for(o=e[n].querySelectorAll(t),r=o.length;--r>=0;)i.push(o[r]);else i=e.querySelectorAll(t);return 1===i.length&&(i=i[0]),i},e},G={},I={},this.on=function(t,e){return G[t]||(G[t]=[]),G[t].push(e)},this.once=function(t,e){return G[t]||(G[t]=[]),I[t]||(I[t]=[]),G[t].push(e),I[t].push(e)},this.emit=function(t){var e,n,r,o,i,s;if(G[t]){for(e=Array.prototype.slice.call(arguments).slice(1),r=0,o=G[t].length,s=[];o>r;)n=G[t][r],n&&(I[t]&&(i=I[t].indexOf(n),i>-1&&(I[t].splice(i,1),G[t].splice(r,1),r--)),n.apply(this,e)),s.push(r++);return s}},this.listeners=function(t){return G[t]||(G[t]=[]),G[t]},this.removeAllListeners=function(t){return G[t]=[],I[t]=[]},-1===Object.keys(this.options).indexOf("loader")&&(this.options.loader=!0),this.options.loader&&(w=!1,v=!1,this.loader={src:"../images/loader.gif",show:function(){K.emit("create_loader"),v.setAttribute("style","cursor:progress");try{w.setAttribute("src",K.loader.src),v.appendChild(w)}catch(t){K.log.error("error show loader")}return!0},hide:function(){try{v.removeChild(w)}catch(t){K.log.error("error hide loader")}return v.setAttribute("style","cursor:auto"),!0}},this.on("start",function(){return K.loader.show()}),this.on("end",function(){return K.loader.hide()}),this.once("create_loader",function(){return v=K.$("html"),w=K.document.createElement("img"),w.setAttribute("style","z-index:1000;display:block;width:30px;height:30px;left:50%;top:50%;position:fixed;margin-left:-15px;margin-top:-15px;")})),B={},this.load=function(t,e,n){return n||(n=e),e||(e={}),e.type||(e.type="text"),K.load.cache.text[t]?n(null,K.load.cache.text[t]):B[t]?(K.log.debug("add load queue for "+t),K.once("load: "+t,function(e){return n(e,K.load.cache.text[t])})):(B[t]=!0,K.load.load(t,e,function(e,r){return K.load.cache.text[t]=r,e&&K.log.error("error load "+t),B[t]=!1,K.emit("load: "+t,e),n(e,K.load.cache.text[t])}))},this.load.load=function(t,e,n){var r;return n||(n=e),e||(e={}),e.type||(e.type="text"),r=l(),r.open("GET",t,!0),"json"===e.type?(r.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),r.setRequestHeader("Accept","application/json, text/javascript")):r.setRequestHeader("Content-Type","text/plain; charset=UTF-8"),r.onreadystatechange=function(){return 4===r.readyState?200===r.status?n(0,r.responseText):n(0,null):void 0},r.send(null)},this.options.load&&(this.load.load=this.options.load),this.load.json=function(t,e,n){return n||(n=e),e||(e={}),e.type="json",K.load.cache.data[t]?n(null,K.load.cache.data[t]):K.load(t,e,function(e,r){try{K.load.cache.data[t]=JSON.parse(r)}catch(o){K.log.error("wrong json data "+t)}return n(e,K.load.cache.data[t])})},this.load.js=function(t,e,n){return n||(n=e),e||(e={}),e.type="text",/^http(s){0,1}:\/\//.test(t)?(L(t),n(0)):K.load(t,function(e,r,o){if(e)return n(e);try{return g(o),n(0)}catch(i){return this.log.error("wrong js "+t),n(i)}})},this.load.exec=this.load.js,H=!1,this.load.script=function(t){if(H)return setTimeout(function(){return this.load.script(t)},1),void 0;if(H=!0,t.src)return K.load.js(t.src,function(){return H=!1});try{g(t.innerHTML)}catch(e){K.log.error("Ошибка в скрипте.")}return H=!1},this.load.css=function(t){var e,n;if(!K.load.cache.css[t])return K.load.cache.css[t]=!0,n=K.document.createElement("style"),n.type="text/css",n.styleSheet?n.styleSheet.cssText=t:n.appendChild(K.document.createTextNode(t)),e=K.$("head"),e.insertBefore(n,e.lastChild)},this.load.style=this.load.styles=this.load.css,this.load.clearCache=function(t){return null==t?(K.load.cache.data={},K.load.cache.text={}):t.constructor===RegExp?(X(t,K.load.cache.data),X(t,K.load.cache.text)):(delete K.load.cache.data[t],delete K.load.cache.text[t])},this.load.cache={css:{},data:{},text:{}},X=function(t,e){var r,o;o=[];for(r in e)n.call(e,r)&&(t.test(r)?o.push(delete e[r]):o.push(void 0));return o},l=function(){var t;return"undefined"!=typeof XMLHttpRequest&&null!==XMLHttpRequest?new XMLHttpRequest:(t=function(){try{return new ActiveXObject("Msxml2.XMLHTTP.6.0")}catch(t){}try{return new ActiveXObject("Msxml2.XMLHTTP.3.0")}catch(t){}try{return new ActiveXObject("Msxml2.XMLHTTP")}catch(t){}try{return new ActiveXObject("Microsoft.XMLHTTP")}catch(t){}throw Error("This browser does not support XMLHttpRequest.")},t())},g=function(t){var e,n;return e=K.$("head"),n=K.document.createElement("script"),n.type="text/javascript",n.text=t,e.insertBefore(n,e.firstChild),e.removeChild(n)},L=function(t){var e,n;return n=K.document.createElement("script"),n.type="text/javascript",e=K.$("head"),n.src=t,e.insertBefore(n,e.firstChild),e.removeChild(n)},h=function(t){return t()},this.options.index&&(this.index=this.options.index),a=1,this.options.check_queue&&(a=this.options.check_queue),s=100,this.options.check_limit&&(s=this.options.check_limit),c=1e4,this.options.check_timeout&&(c=this.options.check_timeout),this.check_status="stop",this.check_count=0,N=function(t){var e,r,o,i;e={},i=[];for(r in t)n.call(t,r)&&(o=t[r],i.push(K.emit("compile",e,r,o)));return i},this.compile=function(t){var e,n,r;if(t&&(K.index=t),K.layers=[],K.index.splice)for(e=K.index.length;--e>=0;)N(K.index[e]);else N(K.index);for(K.ids={},e=K.layers.length,r=[];--e>=0;)n=K.layers[e],n.oncheck||(n.oncheck=h),n.onload||(n.onload=h),n.onshow||(n.onshow=h),n.config||(n.config={}),n.state||(n.state="/"),n.id||(n.id=e),K.ids[n.id]=n,"^"!==n.state[0]&&"$"!==n.state.slice(-1)?r.push(n.state="^"+n.state+".*$"):r.push(void 0);return r},this.on("start",function(){return K.log.debug("first circle, queue: "+K.listeners("queue").length),K.circle={interrupt:!1,count:0,occupied:{},loading:0,state:K.state,limit:s,queue:a,length:K.layers.length,cb:null,timeout:c,time:Date.now()}}),this.on("circle",function(){var t;return t=K.check_count,setTimeout(function(){var e,n;if("run"===K.check_status&&t===K.check_count){for(e=K.circle.length;--e>=0;)"queue"===K.layers[e].status&&(K.circle.num=e,K.emit("layer",K.layers[e],e));if(n=K.listeners("circle"),++K.circle.count>=K.circle.limit&&(K.log.warn(K.circle.limit+" limit"),n=n.splice(1,n.length)),K.circle.timeout<Date.now()-K.circle.time&&(K.log.warn(K.circle.timeout+" timeout"),n=n.splice(1,n.length)),n.length>1)return K.emit("circle");if(!K.circle.loading)return K.emit("end")}},1)}),p=function(t){var e;if(K.check_status="run",K.circle.cb=t,K.circle.state){for(e=K.circle.length;--e>=0;)K.layers[e].status="queue",K.layers[e].node=null;return K.emit("circle")}return K.log.warn("no set circle.state"),K.emit("end")},this.on("end",function(){return K.log.debug("end check, circle.count: "+K.circle.count+", check_count: "+K.check_count),"function"==typeof K.circle.cb?K.circle.cb(function(){return K.check_status="stop1"}):K.check_status="stop2",K.emit("queue")}),this.check=function(t){var e;return"run"===K.check_status?(K.circle.interrupt=!0,K.once("queue",function(){return K.check(t)}),e=K.listeners("queue"),e.splice(0,e.length-K.circle.queue),K.log.debug("check queue, listeners "+e.length)):"pause"!==K.check_status?(K.check_count++,K.layers.length||K.compile(),K.layers.length||K.log.info("empty layers"),K.emit("start"),t!==!0?p(t):K.check_status="pause"):t!==!0?p(t):void 0},j=["tag","state","css","json","tpl","ext","tplString","htmlString","id"],O=["config","data"],S=["oncheck","onload","onshow"],this.labels={},this.on("compile",function(t,e,n){var r,o,i;if(j.indexOf(e)>=0)return"[object String]"===Object.prototype.toString.apply(n)?("tag"===e&&-1===K.layers.indexOf(t)&&K.layers.push(t),t[e]=n):K.log.error("bad value",e,n);if(O.indexOf(e)>=0)return"[object Object]"===Object.prototype.toString.apply(n)?t[e]=n:K.log.error("bad value",e,n);if(S.indexOf(e)>=0)return t["_"+e]=n,K.functions&&"[object String]"===Object.prototype.toString.apply(n)&&K.functions[n]&&(n=K.functions[n]),t[e]=function(r){try{return n.call(t,r)}catch(o){return K.log.error(e+" "+o),r()}};if("div"===e)return"[object String]"===Object.prototype.toString.apply(n)?t.tag="#"+n:K.log.error("bad value",e,n);if("label"===e){if("[object String]"===Object.prototype.toString.apply(n)){for(t[e]=n,o=n.replace(/\s+/g," ").trim().split(" "),r=o.length,i=[];--r>=0;)K.labels[o[r]]||(K.labels[o[r]]=[]),i.push(K.labels[o[r]].push(t));return i}return K.log.error("bad value",e,n)}}),q=["states","tags","divs"],this.on("compile",function(t,e,r){var o,i,s,a,c,l;if(q.indexOf(e)>=0){if("[object Object]"===Object.prototype.toString.apply(r)){-1===K.layers.indexOf(t)&&K.layers.push(t),t.childs||(t.childs=[]),"states"!==e||t.states||(t.states={}),"tags"!==e&&"divs"!==e||t.tags||(t.tags={}),l=[];for(i in r)n.call(r,i)&&("[object Object]"===Object.prototype.toString.apply(r[i])?(o={},o.parent=t,K.layers.push(o),t.childs.push(o),"states"===e?(a=i,t.states[a]=o,"^"===a[0]||"$"===a.slice(-1)?o.state=a:(o.parent.state||(o.parent.state="/"),o.state=o.parent.state+a+"/")):(c="tags"===e?i:"#"+i,o.tag=c,o.state=t.state,t.tags[o.tag]=o),l.push(function(){var t,e;t=r[i],e=[];for(s in t)n.call(t,s)&&e.push(this.emit("compile",o,s,r[i][s]));return e}.call(K))):l.push(K.log.error("bad value",e,r[i])));return l}return K.log.error("bad value",e,r)}}),this.external=function(t,e){return t.ext&&!t._ext?(K.log.debug("new external",t.ext),K.load(t.ext,function(r,o){var i,s,a,c,l,u,h,d,p;if(t._ext={},r)return e();try{try{t._ext=eval_("("+o+")")}catch(f){t._ext=eval_(o)}if(a=this.layers,this.compile(t._ext),t._ext=this.layers,this.layers=a,t.config&&t._ext[0].config){d=t._ext[0].config;for(u in d)n.call(d,u)&&(t.config[u]||(t.config[u]=t._ext[0].config[u]))}p=t._ext[0];for(h in p)n.call(p,h)&&(t[h]||(t[h]=t._ext[0][h]));for(i=["onload","oncheck","onshow"],s=0,c=i.length;c>s;)(function(e){var n;return n=t["_"+e],n?t[e]=function(r){try{return n.call(t,r)}catch(o){return this.log.error(e+" "+o),r()}}:void 0})(i[s]),s++;if(c=t._ext.length)for(l=this.layers.indexOf(t),s=1;c>s;)l++,this.layers.splice(l,0,t._ext[s]),s++;return e()}catch(f){return this.log.error("wrong ext",t.ext),e()}})):e()},this.tplParser=function(t,e,n){var r;return r="tplParser is not set",n?n(r):r},this.options.tplParser&&(this.tplParser=this.options.tplParser),M=function(t,e){return t.onload(function(){return"string"==typeof t.tplString?K.tplParser(t.tplString,t,function(n){return t.htmlString=n,e()}):(K.log.error("Wrong tplString "+t.tpl),t.htmlString=" ",e())})},R=function(t,e){return t.tplString?e():(t.tplString=" ",t.tpl?K.load(t.tpl,function(n,r){return n||(t.tplString=r),e()}):e())},A=function(t,e){return t.data?e():(t.data={},t.json?K.load.json(t.json,function(n,r){return n||(t.data=r),e()}):e())},this.insert=function(t,e){var n,r;return n=2,r=function(){return 0===--n?M(t,function(){return e()}):void 0},t.htmlString?e():t.tpl||t.tplString?(R(t,function(){return r()}),A(t,function(){return r()})):e(1)},E=function(t){return t.parent&&!t.parent.show?"no parent":K.circle.occupied[t.tag]?"busy tag "+t.tag:(t.node||(t.node=K.$(t.tag)),t.node&&0!==t.node.length?!t.show&&i(t)?4:C(t)?!0:"state mismatch":"not inserted")},this.checkLayer=E,i=function(t){var e,r,o;t.node||(t.node=K.$(t.tag)),o=K.circle.occupied;for(r in o)if(n.call(o,r)&&t.node&&t.node.length&&(e=t.node.find(K.circle.occupied[r]),e&&0!==e.length))return!0;return!1},C=function(t){return t.reg_state&&t.reg_state[0]&&K.circle.state===t.reg_state[0]?!0:!1},this.pasteHTML=function(t,e){return K.$(t).innerHTML=e},D=function(t){var e;if(t.status="_hide",t.childs)for(e=t.childs.length;--e>=0;)D(t.childs[e]);return K.pasteHTML(t.tag,""),t.show=!1,t.status="hidden"},y=function(t){return t.status="hide",D(t)},u=function(t){var e,n,r;for(t.status="displace",n=K.circle.length,r=[];--n>=0;)K.layers[n].show?t.tag===K.layers[n].tag||(K.$(t.tag)===K.$(K.layers[n].tag)?r.push(D(K.layers[n])):(e=K.$(t.tag).find(K.layers[n].tag),e&&0!==e.length?r.push(D(K.layers[n])):r.push(void 0))):r.push(void 0);return r},o=function(t){return t.status="apply",K.circle.occupied[t.tag]=t,t.show||u(t),K.once("circle",function(){return K.circle.interrupt?(K.log.debug("check interrupt 1"),K.emit("circle")):(K.circle.loading++,K.external(t,function(){return t.oncheck(function(){return t.status="insert",t.show?(K.circle.loading--,K.emit("circle")):K.insert(t,function(e){return e?(K.log.error("layer can not be inserted",t.id),t.status="wrong insert",K.circle.loading--,K.emit("circle")):K.circle.interrupt?(K.log.debug("check interrupt 2"),K.circle.loading--,K.emit("circle")):(K.pasteHTML(t.tag,t.htmlString),t.last_state=K.circle.state,t.show=!0,t.onshow(function(){return K.circle.loading--,K.emit("circle")}))})})}))})},this.on("layer",function(t){return t.check=E(t),t.check===!0?o(t):t.show?y(t):void 0}),null==this.options.links&&(this.options.links=!1),x=["^javascript:","^mailto:","^http://","^https://","^ftp://","^//"],this.getState=function(t){var e;return t||(t="/"),e=decodeURIComponent(location.pathname),t=decodeURIComponent(t),t=t.replace(/#.+/,""),"/"!==t[0]&&(t=e+"/"+t),t=t.replace(/\/{2,}/g,"/")},T=function(t){return"A"===t.nodeName?t:t.parentNode&&"HTML"!==t.parentNode?T(t.parentNode):!1},m=function(t){var e,n,r,o;if(t=t||window.event,!(t.metaKey||t.shiftKey||t.altKey||t.ctrlKey)&&(o=t.target||t.srcElement,o=T(o),o&&(e=o.getAttribute("href"),r=!1,e&&!o.getAttribute("target")))){for(n=x.length;--n>=0;)RegExp(x[n],"gim").test(e)&&(r=!0);if(!r)try{return t.preventDefault?t.preventDefault():t.returnValue=!1,K.state=K.getState(e),K.check(function(t){return K.hash=o.hash,t()})}catch(t){return window.location=e}}},$=function(){var t,e,n;for(t=K.$("a"),e=t.length,n=[];--e>=0;)n.push(t[e].onclick=m);return n},this.options.links&&($(),this.on("start",function(){return K.noscroll||window.scrollTo(0,0),K.noscroll=!1}),this.on("end",function(){return $()})),null==this.options.address_bar&&(this.options.address_bar=!1),this.options.address_bar&&(this.state=this.getState(location.pathname),this.log.debug("setting onpopstate event for back and forward buttons"),setTimeout(function(){return window.onpopstate=function(){var t;return K.log.debug("onpopstate"),K.hash?void 0:(t=K.getState(location.pathname),K.state=t,K.check(function(t){return K.hash=location.hash,t()}))}},1e3),k=void 0,this.on("start",function(){return k=K.getState(location.pathname),K.state!==k?(K.log.debug("push state "+K.state+" replace hash "+K.hash),history.pushState(null,null,K.state)):void 0}),this.on("end",function(){return K.state!==k?K.hash&&location.replace(K.hash):(K.log.debug("replace state "+K.state+" push hash "+K.hash),history.replaceState(null,null,K.state),K.hash&&(location.href=K.hash)),K.hash=""})),null==this.options.cache&&(this.options.cache=!1),d=function(){},f=function(){var e,n,r;for(t=window.Infra,K.load.cache=t.server.cache,e=K.layers.length,r=[];--e>=0;)if(n=K.layers[e],n.show=t.server.showns[e],n.show){!n.data&&n.json&&K.load.cache.data[n.json]&&(n.data=K.load.cache.data[n.json]),!n.htmlString&&!n.tplString&&n.tpl&&K.load.cache.text[n.tpl]&&(n.tplString=K.load.cache.text[n.tpl]),n.reg_state=K.state.match(RegExp(n.state,"im"));try{r.push(n.onshow.bind(n)(d))}catch(o){r.push(K.log.error("onshow() "+e+" "+o))}}else r.push(void 0);return r},this.options.cache&&this.once("start",function(){try{return f()}catch(t){return K.log.warn("fail cache")}}),this.reparseLayer=function(t){var e,n;if(t.show=!1,t.json&&(t.data=!1),t.tpl?(t.tplString="",t.htmlString=""):t.tplString&&(t.htmlString=""),t.childs){for(e=t.childs.length,n=[];--e>=0;)n.push(t.childs[e].show=!1);return n}},this.reparseAll=function(){var t,e;for(t=K.layers.length,e=[];--t>=0;)e.push(K.reparseLayer(K.layers[t]));return e},P=function(t,e){var n,r;for(n=void 0,r=K.layers.length;--r>=0&&!(n=RegExp(K.layers[r].state).test(t)););return e(n)},this.checkExists=function(t,e){return K.layers.length?P(t,e):(K.compile(K.index),P(t,e))},this.oncheckTplOptions=function(t,e){var n,r;return e||(e=K),n=2,r=function(){return 0===--n?t():void 0},K.tplParser(e.tpl,e,function(t){return e.tpl=t,r()}),K.tplParser(e.json,e,function(t){return e.json=t,r()})},this.head=function(t){return K.on("start",function(){return K.meta={},K.meta.keywords=t.meta.keywords,K.meta.description=t.meta.description,K.status_code=200,K.title=!1}),K.on("end",function(){var e,n,r,o;return K.title||(K.title=404===K.status_code?t.title["404"]:"/"===K.state?t.title.main:K.state.replace(/\/+$/,"").replace(/^\/+/,"").split("/").reverse().join(" / ")+t.title.sub,K.last_status_code=K.status_code),K.document.title=K.title,K.meta.keywords||(K.meta.keywords=""),K.meta.description||(K.meta.description=""),n=K.$("head"),e=K.$("meta[name=description]"),r=K.$("meta[name=keywords]"),r&&0!==r.length&&n.removeChild(r),e&&0!==e.length&&n.removeChild(e),o=K.document.createElement("meta"),o.setAttribute("name","description"),o.setAttribute("content",K.meta.description),n.appendChild(o),o=K.document.createElement("meta"),o.setAttribute("name","keywords"),o.setAttribute("content",K.meta.keywords),n.appendChild(o)})},this.on("compile",function(t,e,n){return"jsontpl"===e?t[e]=n:void 0}),this.on("start",function(){var t,e;for(t=K.layers.length,e=[];--t>=0;)K.state&&(K.layers[t].reg_state=K.state.match(RegExp(K.layers[t].state,"im"))),K.layers[t].jsontpl?e.push(K.layers[t].json=K.tplParser(K.layers[t].jsontpl,K.layers[t])):e.push(void 0);return e})}return t}(),"undefined"==typeof window||null===window?module.exports=t:window.Infra=t}).call(this);