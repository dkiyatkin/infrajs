(function(){var t,e=[].slice,n={}.hasOwnProperty;t=function(){function t(r){var o,i,s,c,a,l,u,h,d,p,f,g,y,m,v,x,w,b,j,_,S,k,O,T,q,A,R,$,M,L,E,H,C,X,N,P,D,I,G,B=this;this.options=null!=r?r:{},this.layers=[],this.log={debug:function(){var t;return t=arguments.length>=1?e.call(arguments,0):[],w(t,3)},info:function(){var t;return t=arguments.length>=1?e.call(arguments,0):[],w(t,2)},warn:function(){var t;return t=arguments.length>=1?e.call(arguments,0):[],w(t,1)},error:function(){var t;return t=arguments.length>=1?e.call(arguments,0):[],w(t,0)},logger:"WARNING",quiet:!1},this.options.log&&(this.log.logger=this.options.log),this.options.logger&&(this.log.logger=this.options.logger),b=["ERROR","WARNING","INFO","DEBUG"],w=function(t,e){return b.indexOf(B.log.logger)>=e?(t="["+(new Date).toGMTString()+"] "+b[e]+" "+t.join(" "),B.log.quiet||(3===e&&console.log(t),2===e&&console.info(t),1===e&&console.warn(t),0===e&&console.error(t)),t):void 0},this.options.document?this.document=this.options.document:"undefined"!=typeof window&&null!==window&&(this.document=window.document),this.$=this.options.$?this.options.$:function(t){var e;return e=B.document.querySelectorAll(t),1===e.length&&(e=e[0]),e.find=function(t){var n,r,o,i;if(i=[],e&&e.length)for(n=e.length;--n>=0;)for(o=e[n].querySelectorAll(t),r=o.length;--r>=0;)i.push(o[r]);else i=e.querySelectorAll(t);return 1===i.length&&(i=i[0]),i},e},I={},P={},this.on=function(t,e){return I[t]||(I[t]=[]),I[t].push(e)},this.once=function(t,e){return I[t]||(I[t]=[]),P[t]||(P[t]=[]),I[t].push(e),P[t].push(e)},this.emit=function(t){var e,n,r,o,i,s;if(I[t]){for(e=Array.prototype.slice.call(arguments).slice(1),r=0,o=I[t].length,s=[];o>r;)n=I[t][r],n&&(P[t]&&(i=P[t].indexOf(n),i>-1&&(P[t].splice(i,1),I[t].splice(r,1),r--)),n.apply(this,e)),s.push(r++);return s}},this.listeners=function(t){return I[t]||(I[t]=[]),I[t]},this.removeAllListeners=function(t){return I[t]=[],P[t]=[]},this.options.document?this.document=this.options.document:"undefined"!=typeof window&&null!==window&&(this.document=window.document),-1===Object.keys(this.options).indexOf("loader")&&(this.options.loader=!0),this.options.loader&&(x=!1,m=!1,this.loader={src:"../images/loader.gif",show:function(){B.emit("create_loader"),m.setAttribute("style","cursor:progress");try{x.setAttribute("src",B.loader.src),m.appendChild(x)}catch(t){B.log.error("error show loader")}return!0},hide:function(){try{m.removeChild(x)}catch(t){B.log.error("error hide loader")}return m.setAttribute("style","cursor:auto"),!0}},this.on("start",function(){return B.loader.show()}),this.on("end",function(){return B.loader.hide()}),this.once("create_loader",function(){return m=B.$("html"),x=B.document.createElement("img"),x.setAttribute("style","z-index:1000;display:block;width:30px;height:30px;left:50%;top:50%;position:fixed;margin-left:-15px;margin-top:-15px;")})),G={},this.load=function(t,e,n){return n||(n=e),e||(e={}),e.type||(e.type="text"),B.load.cache.text[t]?n(null,B.load.cache.text[t]):G[t]?(B.log.debug("add load queue for "+t),B.once("load: "+t,function(e){return n(e,B.load.cache.text[t])})):(G[t]=!0,B.load.load(t,e,function(e,r){return B.load.cache.text[t]=r,e&&B.log.error("error load "+t),G[t]=!1,B.emit("load: "+t,e),n(e,B.load.cache.text[t])}))},this.load.load=function(t,e,n){var r;return n||(n=e),e||(e={}),e.type||(e.type="text"),r=l(),r.open("GET",t,!0),"json"===e.type?(r.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),r.setRequestHeader("Accept","application/json, text/javascript")):r.setRequestHeader("Content-Type","text/plain; charset=UTF-8"),r.onreadystatechange=function(){return 4===r.readyState?200===r.status?n(0,r.responseText):n(0,null):void 0},r.send(null)},this.options.load&&(this.load.load=this.options.load),this.load.json=function(t,e,n){return n||(n=e),e||(e={}),e.type="json",B.load.cache.data[t]?n(null,B.load.cache.data[t]):B.load(t,e,function(e){try{B.load.cache.data[t]=JSON.parse(json)}catch(r){B.log.error("wrong json data "+t)}return n(e,B.load.cache.data[t])})},this.load.js=function(t,e,n){return n||(n=e),e||(e={}),e.type="text",/^http(s){0,1}:\/\//.test(t)?(M(t),n(0)):B.load(t,function(e,r,o){if(e)return n(e);try{return f(o),n(0)}catch(i){return this.log.error("wrong js "+t),n(i)}})},this.load.exec=this.load.js,H=!1,this.load.script=function(t){if(H)return setTimeout(function(){return this.load.script(t)},1),void 0;if(H=!0,t.src)return B.load.js(t.src,function(){return H=!1});try{f(t.innerHTML)}catch(e){B.log.error("Ошибка в скрипте.")}return H=!1},this.load.css=function(t){var e,n;if(!B.load.cache.css[t])return B.load.cache.css[t]=!0,n=document.createElement("style"),n.type="text/css",n.styleSheet?n.styleSheet.cssText=t:n.appendChild(document.createTextNode(t)),e=B.$("head"),e.insertBefore(n,e.lastChild)},this.load.style=this.load.styles=this.load.css,this.load.clearCache=function(t){return null==t?(B.load.cache.data={},B.load.cache.text={}):t.constructor===RegExp?(X(t,B.load.cache.data),X(t,B.load.cache.text)):(delete B.load.cache.data[t],delete B.load.cache.text[t])},this.load.cache={css:{},data:{},text:{}},X=function(t,e){var r,o;o=[];for(r in e)n.call(e,r)&&(t.test(r)?o.push(delete e[r]):o.push(void 0));return o},l=function(){var t;return"undefined"!=typeof XMLHttpRequest&&null!==XMLHttpRequest?XMLHttpRequest():(t=function(){try{return new ActiveXObject("Msxml2.XMLHTTP.6.0")}catch(t){}try{return new ActiveXObject("Msxml2.XMLHTTP.3.0")}catch(t){}try{return new ActiveXObject("Msxml2.XMLHTTP")}catch(t){}try{return new ActiveXObject("Microsoft.XMLHTTP")}catch(t){}throw Error("This browser does not support XMLHttpRequest.")},t())},f=function(t){var e,n;return e=B.$("head"),n=document.createElement("script"),n.type="text/javascript",n.text=t,e.insertBefore(n,e.firstChild),e.removeChild(n)},M=function(t){var e,n;return n=document.createElement("script"),n.type="text/javascript",e=B.$("head"),n.src=t,e.insertBefore(n,e.firstChild),e.removeChild(n)},h=function(t){return t()},this.options.index&&(this.index=this.options.index),c=1,this.options.check_queue&&(c=this.options.check_queue),s=100,this.options.check_limit&&(s=this.options.check_limit),a=1e4,this.options.check_timeout&&(a=this.options.check_timeout),this.check_status="stop",this.check_count=0,N=function(t){var e,r,o,i;e={},i=[];for(r in t)n.call(t,r)&&(o=t[r],i.push(B.emit("compile",e,r,o)));return i},this.compile=function(t){var e,n,r;if(t&&(B.index=t),B.layers=[],B.index.splice)for(e=B.index.length;--e>=0;)N(B.index[e]);else N(B.index);for(B.ids={},e=B.layers.length,r=[];--e>=0;)n=B.layers[e],n.oncheck||(n.oncheck=h),n.onload||(n.onload=h),n.onshow||(n.onshow=h),n.config||(n.config={}),n.state||(n.state="/"),n.id||(n.id=e),B.ids[n.id]=n,"^"!==n.state[0]&&"$"!==n.state.slice(-1)?r.push(n.state="^"+n.state+".*$"):r.push(void 0);return r},this.on("start",function(){return B.log.debug("first circle, queue: "+B.listeners("queue").length),B.circle={interrupt:!1,count:0,occupied:{},state:B.state,limit:s,queue:c,length:B.layers.length,cb:null,timeout:a,time:Date.now()}}),this.on("circle",function(){var t;return t=B.check_count,setTimeout(function(){var e,n;if("run"===B.check_status&&t===B.check_count){for(e=B.circle.length;--e>=0;)"queue"===B.layers[e].status&&(B.circle.num=e,B.emit("layer",B.layers[e],e));return n=B.listeners("circle"),++B.circle.count>=B.circle.limit&&(B.log.warn(B.circle.limit+" limit"),n=n.splice(1,n.length)),B.circle.timeout<Date.now()-B.circle.time&&(B.log.warn(B.circle.timeout+" timeout"),n=n.splice(1,n.length)),n.length>1?B.emit("circle"):B.emit("end")}},1)}),d=function(t){var e,n;if(B.check_status="run",B.circle.cb=t,B.circle.state){for(e=B.circle.length;--e>=0;)B.layers[e].status="queue",n=RegExp(B.layers[e].state,"im"),B.layers[e].reg_state=B.circle.state.match(n),B.layers[e].node=null;return B.emit("circle")}return B.log.warn("no set circle.state"),B.emit("end")},this.on("end",function(){return B.log.debug("end check, circle.count: "+B.circle.count+", check_count: "+B.check_count),"function"==typeof B.circle.cb?B.circle.cb(function(){return B.check_status="stop1"}):B.check_status="stop2",B.emit("queue")}),this.check=function(t){var e;return"run"===B.check_status?(B.circle.interrupt=!0,B.once("queue",function(){return B.check(t)}),e=B.listeners("queue"),e.splice(0,e.length-B.circle.queue),B.log.debug("check queue, listeners "+e.length)):"pause"!==B.check_status?(B.check_count++,B.layers.length||B.compile(),B.layers.length||B.log.info("empty layers"),B.emit("start"),t!==!0?d(t):B.check_status="pause"):t!==!0?d(t):void 0},_=["tag","state","css","json","tpl","ext","tplString","htmlString","id"],k=["config","data"],S=["oncheck","onload","onshow"],this.labels={},this.on("compile",function(t,e,n){var r,o,i;if(_.indexOf(e)>=0)return"[object String]"===Object.prototype.toString.apply(n)?("tag"===e&&-1===B.layers.indexOf(t)&&B.layers.push(t),t[e]=n):B.log.error("bad value",e,n);if(k.indexOf(e)>=0)return"[object Object]"===Object.prototype.toString.apply(n)?t[e]=n:B.log.error("bad value",e,n);if(S.indexOf(e)>=0)return t["_"+e]=n,B.functions&&"[object String]"===Object.prototype.toString.apply(n)&&B.functions[n]&&(n=B.functions[n]),t[e]=function(r){try{return n.call(t,r)}catch(o){return B.log.error(e+" "+o),r()}};if("div"===e)return"[object String]"===Object.prototype.toString.apply(n)?t.tag="#"+n:B.log.error("bad value",e,n);if("label"===e){if("[object String]"===Object.prototype.toString.apply(n)){for(t[e]=n,o=n.replace(/\s+/g," ").trim().split(" "),r=o.length,i=[];--r>=0;)B.labels[o[r]]||(B.labels[o[r]]=[]),i.push(B.labels[o[r]].push(t));return i}return B.log.error("bad value",e,n)}}),T=["states","tags","divs"],this.on("compile",function(t,e,r){var o,i,s,c,a,l;if(T.indexOf(e)>=0){if("[object Object]"===Object.prototype.toString.apply(r)){-1===B.layers.indexOf(t)&&B.layers.push(t),t.childs||(t.childs=[]),"states"!==e||t.states||(t.states={}),"tags"!==e&&"divs"!==e||t.tags||(t.tags={}),l=[];for(i in r)n.call(r,i)&&("[object Object]"===Object.prototype.toString.apply(r[i])?(o={},o.parent=t,B.layers.push(o),t.childs.push(o),"states"===e?(c=i,t.states[c]=o,"^"===c[0]||"$"===c.slice(-1)?o.state=c:(o.parent.state||(o.parent.state="/"),o.state=o.parent.state+c+"/")):(a="tags"===e?i:"#"+i,o.tag=a,o.state=t.state,t.tags[o.tag]=o),l.push(function(){var t,e;t=r[i],e=[];for(s in t)n.call(t,s)&&e.push(this.emit("compile",o,s,r[i][s]));return e}.call(B))):l.push(B.log.error("bad value",e,r[i])));return l}return B.log.error("bad value",e,r)}}),this.external=function(t,e){return t.ext&&!t._ext?(B.log.debug("new external",t.ext),B.load(t.ext,function(r,o){var i;if(t._ext={},r)return e();try{try{t._ext=eval_("("+o+")")}catch(s){t._ext=eval_(o)}return i=this.layers,this.compile(t._ext,function(){var r,o,s,c,a,l,u,h;if(t._ext=this.layers,this.layers=i,t.config&&t._ext[0].config){u=t._ext[0].config;for(a in u)n.call(u,a)&&(t.config[a]||(t.config[a]=t._ext[0].config[a]))}h=t._ext[0];for(l in h)n.call(h,l)&&(t[l]||(t[l]=t._ext[0][l]));for(r=["onload","oncheck","onshow"],o=0,s=r.length;s>o;)(function(e){var n;return n=t["_"+e],n?t[e]=function(r){try{return n.call(t,r)}catch(o){return this.log.error(e+" "+o),r()}}:void 0})(r[o]),o++;if(s=t._ext.length)for(c=this.layers.indexOf(t),o=1;s>o;)c++,this.layers.splice(c,0,t._ext[o]),o++;return e()})}catch(s){return this.log.error("wrong ext",t.ext),e()}})):e()},this.tplParser=function(t,e,n){var r;return r="tplParser is not set",n?n(r):r},this.options.tplParser&&(this.tplParser=this.options.tplParser),R=function(t,e){return t.onload(function(){return"string"==typeof t.tplString?this.tplParser(t.tplString,t,function(n){return t.htmlString=n,e()}):(this.log.error("Wrong tplString "+t.tpl),t.htmlString=" ",e())})},$=function(t,e){return t.tplString?e():(t.tplString=" ",t.tpl?this.load(t.tpl,function(n,r){return n||(t.tplString=r),e()}):e())},q=function(t,e){return t.data?e():(t.data={},t.json?this.load.json(t.json,function(n,r){return n||(t.data=r),e()}):e())},this.insert=function(t,e){var n,r;return n=2,r=function(){return 0===--n?R(t,function(){return e()}):void 0},t.htmlString?e():t.tpl||t.tplString?($(t,function(){return r()}),q(t,function(){return r()})):e(1)},E=function(t){return t.parent&&!t.parent.show?"no parent":B.circle.occupied[t.tag]?"busy tag "+t.tag:(t.node||(t.node=B.$(t.tag)),t.node&&0!==t.node.length?!t.show&&i(t)?4:L(t)?!0:"state mismatch":"not inserted")},this.checkLayer=E,i=function(t){var e,r;t.node||(t.node=B.$(t.tag)),r=B.circle.occupied;for(e in r)if(n.call(r,e)&&t.node&&t.node.length&&t.node.find(B.circle.occupied[e]))return!0;return!1},L=function(t){return t.reg_state&&t.reg_state[0]&&B.circle.state===t.reg_state[0]?!0:!1},D=function(t){var e;if(t.status="_hide",t.childs)for(e=t.childs.length;--e>=0;)D(t.childs[e]);return B.$(t.tag).innerHTML="",t.show=!1,t.status="hidden"},y=function(t){return t.status="hide",B.once("circle",function(){return D(t),B.emit("circle")})},u=function(t){var e,n,r;for(t.status="displace",n=B.circle.length,r=[];--n>=0;)B.layers[n].show?t.tag===B.layers[n].tag||(B.$(t.tag)===B.$(B.layers[n].tag)?r.push(D(B.layers[n])):(e=B.$(t.tag).find(B.layers[n].tag),e&&e.length?r.push(D(B.layers[n])):r.push(void 0))):r.push(void 0);return r},o=function(t){return t.status="apply",B.circle.occupied[t.tag]=t,t.show||u(t),B.once("circle",function(){return B.circle.interrupt?(B.log.debug("check interrupt 1"),B.emit("circle")):B.external(t,function(){return t.oncheck(function(){return t.status="insert",t.show?B.emit("circle"):B.insert(t,function(e){return e?(B.log.error("layer can not be inserted",t.id),t.status="wrong insert",B.emit("circle")):B.circle.interrupt?(B.log.debug("check interrupt 2"),B.emit("circle")):(B.$(t.tag).innerHTML=t.htmlString,t.show=!0,t.onshow(function(){return B.emit("circle")}))})})})})},this.on("layer",function(t){return t.check=E(t),t.check===!0?o(t):t.show?y(t):void 0}),null==this.options.links&&(this.options.links=!1),v=["^javascript:","^mailto:","^http://","^https://","^ftp://","^//"],this.getState=function(t){var e;return t||(t="/"),e=decodeURIComponent(location.pathname),t=decodeURIComponent(t),t=t.replace(/#.+/,""),"/"!==t[0]&&(t=e+"/"+t),t=t.replace(/\/{2,}/g,"/")},O=function(t){return"A"===t.nodeName?t:t.parentNode&&"HTML"!==t.parentNode?O(t.parentNode):!1},g=function(t){var e,n,r,o;if(t=t||window.event,!(t.metaKey||t.shiftKey||t.altKey||t.ctrlKey)&&(o=t.target||t.srcElement,o=O(o),o&&(e=o.getAttribute("href"),r=!1,e&&!o.getAttribute("target")))){for(n=v.length;--n>=0;)RegExp(v[n],"gim").test(e)&&(r=!0);if(!r)try{return t.preventDefault?t.preventDefault():t.returnValue=!1,B.state=B.getState(e),B.check(function(t){return B.hash=o.hash,t()})}catch(t){return window.location=e}}},A=function(){var t,e,n;for(t=B.$("a"),e=t.length,n=[];--e>=0;)n.push(t[e].onclick=g);return n},this.options.links&&(A(),this.on("start",function(){return B.noscroll||window.scrollTo(0,0),B.noscroll=!1}),this.on("end",function(){return A()})),null==this.options.address_bar&&(this.options.address_bar=!1),this.options.address_bar&&(this.state=this.getState(location.pathname),this.log.debug("setting onpopstate event for back and forward buttons"),setTimeout(function(){return window.onpopstate=function(){var t;return B.log.debug("onpopstate"),B.hash?void 0:(t=B.getState(location.pathname),B.state=t,B.check(function(t){return B.hash=location.hash,t()}))}},1e3),j=void 0,this.on("start",function(){return j=B.getState(location.pathname),B.state!==j?(B.log.debug("push state "+B.state+" replace hash "+B.hash),history.pushState(null,null,B.state)):void 0}),this.on("end",function(){return B.state!==j?B.hash&&location.replace(B.hash):(B.log.debug("replace state "+B.state+" push hash "+B.hash),history.replaceState(null,null,B.state),B.hash&&(location.href=B.hash)),B.hash=""})),null==this.options.cache&&(this.options.cache=!1),p=function(){var e,n,r;for(B.load.cache=t.server.cache,e=B.layers.length,r=[];--e>=0;)if(n=B.layers[e],n.show=t.server.showns[e],n.show){!n.data&&n.json&&B.load.cache.data[n.json]&&(n.data=B.load.cache.data[n.json]),!n.htmlString&&!n.tplString&&n.tpl&&B.load.cache.text[n.tpl]&&(n.tplString=B.load.cache.text[n.tpl]),n.reg_state=B.state.match(RegExp("^"+n.state,"im"));try{r.push(n.onshow.bind(n)(h))}catch(o){r.push(B.log.error("onshow() "+e+" "+o))}}else r.push(void 0);return r},this.options.cache&&this.once("start",function(){try{return p()}catch(t){return B.log.warn("fail cache")}}),this.reparseLayer=function(t){var e,n;if(t.show=!1,t.json&&(t.data=!1),t.tpl?(t.tplString="",t.htmlString=""):t.tplString&&(t.htmlString=""),t.childs){for(e=t.childs.length,n=[];--e>=0;)n.push(t.childs[e].show=!1);return n}},this.reparseAll=function(){var t,e;for(t=B.layers.length,e=[];--t>=0;)e.push(B.reparseLayer(B.layers[t]));return e},C=function(t,e){var n,r;for(n=void 0,r=void 0,r=B.layers.length;--r>=0&&!(n=RegExp("^"+B.layers[r].state+"$").test(t)););return e(n)},this.checkExists=function(t,e){return B.layers.length?C(t,e):B.compile(B.index,function(){return C(t,e)})},this.oncheckTplOptions=function(t,e){var n,r;return e||(e=B),n=2,r=function(){return 0===--n?t():void 0},B.parsetpl(e.tpl,e,function(t){return e.tpl=t,r()}),B.parsetpl(e.json,e,function(t){return e.json=t,r()})},null==this.options.title&&(this.options.title=!0),this.on("compile",function(t,e,n){return"jsontpl"===e?t[e]=n:void 0}),this.once("start",function(){var t,e;for(t=B.layers.length,e=[];--t>=0;)B.layers[t].jsontpl?e.push(B.layers[t].json=B.parsetpl(B.layers[t].jsontpl,B.layers[t])):e.push(void 0);return e})}return t}(),"undefined"==typeof window||null===window?module.exports=t:window.Infra=t}).call(this);